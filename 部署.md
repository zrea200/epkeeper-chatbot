## 配置总结

### 1. 数据库配置（可选）

数据库已改为可选。如果不需要存储数据：

在 `.env` 文件中：
```bash
# 不启用数据库（默认）
ENABLE_DATABASE=false
```

如果需要存储数据：
```bash
# 启用数据库
ENABLE_DATABASE=true
DB_HOST=12312312312
DB_PORT=5123
DB_NAME=123
DB_USER=123
DB_PASSWORD=your_password_here
```

### 2. 开发/生产环境切换

#### 开发环境
```bash
# 方式 1: 使用 npm 脚本
pnpm dev

# 方式 2: 使用 Docker Compose
pnpm deploy:dev
# 或
docker-compose -f docker-compose.dev.yml up -d
```

#### 生产环境
```bash
# 方式 1: 直接运行（需要先构建）
pnpm build
pnpm start

# 方式 2: 使用 Docker Compose（推荐）
pnpm deploy:prod
# 或
docker-compose up -d --build
```

### 3. 蓝绿部署

已创建 `docker-compose.blue-green.yml` 配置文件。

#### 使用步骤：

1. 启动绿色环境（新版本）：
```bash
pnpm deploy:blue-green
# 或
docker-compose -f docker-compose.blue-green.yml up -d green
```

2. 测试绿色环境：
```bash
curl http://localhost:51873/api/health
```

3. 切换流量：
   - 更新负载均衡器配置，将流量指向绿色环境
   - 或使用 Traefik/Nginx 等反向代理切换

4. 停止蓝色环境（旧版本）：
```bash
docker-compose -f docker-compose.blue-green.yml stop blue
```

### 4. 金丝雀发布

已创建 `docker-compose.canary.yml` 配置文件。

#### 使用步骤：

1. 启动金丝雀版本：
```bash
pnpm deploy:canary
# 或
docker-compose -f docker-compose.canary.yml up -d canary
```

2. 配置负载均衡器：
   - 10% 流量到 canary（端口 51874）
   - 90% 流量到 stable（端口 51872）

3. 监控和调整：
   - 监控金丝雀版本性能
   - 逐步增加流量（20% → 50% → 100%）
   - 如有问题，立即回滚

4. 回滚（如有问题）：
```bash
docker-compose -f docker-compose.canary.yml stop canary
```

## 快速参考

| 操作 | 命令 |
|------|------|
| 开发环境 | `pnpm dev` 或 `pnpm deploy:dev` |
| 生产环境 | `pnpm deploy:prod` |
| 蓝绿部署 | `pnpm deploy:blue-green` |
| 金丝雀发布 | `pnpm deploy:canary` |
| 查看日志 | `docker-compose logs -f` |
| 停止服务 | `docker-compose down` |

## 环境变量配置（`.env`）

最小配置（不存储数据）：
```bash
# 必须配置
XUNFEI_APP_ID=your_app_id
XUNFEI_API_KEY=your_api_key
XUNFEI_API_SECRET=your_api_secret

# 可选配置
ENABLE_DATABASE=false  # 不启用数据库
CDN_BASE_URL=https://downloaddocparse.langcore.net/images
```

完整配置（需要存储数据）：
```bash
# 必须配置
XUNFEI_APP_ID=your_app_id
XUNFEI_API_KEY=your_api_key
XUNFEI_API_SECRET=your_api_secret

# 数据库配置（可选）
ENABLE_DATABASE=true
DB_HOST=124.220.81.123
DB_PORT=5433
DB_NAME=xhd
DB_USER=postgres
DB_PASSWORD=your_password

# 其他配置
CDN_BASE_URL=https://downloaddocparse.langcore.net/images
WECHAT_APPID=wx816108784dcd5957
WECHAT_APPSECRET=d2fd2d51ef2fbfff8fc4db86cf88a2a5
```

## 注意事项

1. 数据库默认禁用：不配置 `ENABLE_DATABASE=true` 时，数据库功能不会启用
2. 蓝绿部署需要负载均衡器：需要配置 Nginx/Traefik 等反向代理来切换流量
3. 金丝雀发布需要监控：建议配置监控系统（如 Prometheus + Grafana）来观察新版本性能

现在可以：
- 不配置数据库直接运行
- 自由切换开发/生产环境
- 使用蓝绿部署或金丝雀发布进行零停机更新
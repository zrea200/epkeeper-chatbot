# Docker éƒ¨ç½²æ–‡ä»¶è¯´æ˜

æœ¬æ–‡æ¡£è¯´æ˜é¡¹ç›®ä¸­æ‰€æœ‰ Docker ç›¸å…³æ–‡ä»¶çš„ç”¨é€”å’Œä½¿ç”¨æ–¹æ³•ã€‚

## ğŸ“ æ–‡ä»¶åˆ—è¡¨

### æ ¸å¿ƒé…ç½®æ–‡ä»¶

#### 1. `Dockerfile`
- **ç”¨é€”**: Docker é•œåƒæ„å»ºæ–‡ä»¶
- **ç‰¹ç‚¹**:
  - å¤šé˜¶æ®µæ„å»ºï¼ˆbuilder + runnerï¼‰
  - ä½¿ç”¨ Node.js 20 Alpine åŸºç¡€é•œåƒ
  - é root ç”¨æˆ·è¿è¡Œ
  - å†…ç½®å¥åº·æ£€æŸ¥
- **é•œåƒå¤§å°**: çº¦ 200-300MBï¼ˆä¼˜åŒ–åï¼‰

#### 2. `docker-compose.yml`
- **ç”¨é€”**: Docker Compose ç¼–æ’é…ç½®
- **åŠŸèƒ½**:
  - æœåŠ¡å®šä¹‰å’Œé…ç½®
  - ç«¯å£æ˜ å°„ (3000:3000)
  - ç¯å¢ƒå˜é‡è®¾ç½®
  - èµ„æºé™åˆ¶
  - ç½‘ç»œé…ç½®
  - è‡ªåŠ¨é‡å¯ç­–ç•¥

#### 3. `.dockerignore`
- **ç”¨é€”**: æ’é™¤ä¸éœ€è¦æ‰“åŒ…åˆ°é•œåƒä¸­çš„æ–‡ä»¶
- **åŒ…å«**:
  - node_modules
  - æ„å»ºäº§ç‰©
  - å¼€å‘æ–‡ä»¶
  - Git æ–‡ä»¶
  - ç¯å¢ƒå˜é‡æ–‡ä»¶
  - æ–‡æ¡£æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

### é…ç½®ç¤ºä¾‹æ–‡ä»¶

#### 4. `env.example`
- **ç”¨é€”**: ç¯å¢ƒå˜é‡é…ç½®æ¨¡æ¿
- **ä½¿ç”¨æ–¹æ³•**:
  ```bash
  cp env.example .env
  nano .env  # ç¼–è¾‘é…ç½®
  ```

#### 5. `nginx.conf.example`
- **ç”¨é€”**: Nginx åå‘ä»£ç†é…ç½®ç¤ºä¾‹
- **åŠŸèƒ½**:
  - HTTP/HTTPS é…ç½®
  - åå‘ä»£ç†è®¾ç½®
  - Gzip å‹ç¼©
  - é™æ€èµ„æºç¼“å­˜
  - WebSocket æ”¯æŒ
- **ä½¿ç”¨æ–¹æ³•**:
  ```bash
  sudo cp nginx.conf.example /etc/nginx/sites-available/epkeeper-chatbot
  sudo ln -s /etc/nginx/sites-available/epkeeper-chatbot /etc/nginx/sites-enabled/
  sudo nginx -t
  sudo systemctl reload nginx
  ```

### éƒ¨ç½²è„šæœ¬

#### 6. `deploy.sh`
- **ç”¨é€”**: è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èä½¿ç”¨ï¼‰
- **åŠŸèƒ½**:
  - ç³»ç»Ÿè¦æ±‚æ£€æŸ¥
  - æ„å»ºé•œåƒ
  - å¯åŠ¨/åœæ­¢/é‡å¯æœåŠ¡
  - æŸ¥çœ‹æ—¥å¿—å’ŒçŠ¶æ€
  - æ›´æ–°éƒ¨ç½²
  - æ¸…ç†èµ„æº
- **ä½¿ç”¨æ–¹æ³•**:
  ```bash
  chmod +x deploy.sh
  ./deploy.sh --help
  ./deploy.sh --build --up
  ```

#### 7. `Makefile`
- **ç”¨é€”**: ç®€åŒ– Docker å‘½ä»¤
- **åŠŸèƒ½**: æä¾›ç®€çŸ­çš„å‘½ä»¤åˆ«å
- **ä½¿ç”¨æ–¹æ³•**:
  ```bash
  make help    # æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤
  make build   # æ„å»ºé•œåƒ
  make up      # å¯åŠ¨æœåŠ¡
  make logs    # æŸ¥çœ‹æ—¥å¿—
  ```

### æ–‡æ¡£

#### 8. `DEPLOYMENT.md`
- **ç”¨é€”**: å®Œæ•´éƒ¨ç½²æŒ‡å—
- **å†…å®¹**:
  - è¯¦ç»†çš„éƒ¨ç½²æ­¥éª¤
  - ç³»ç»Ÿè¦æ±‚å’Œå®‰è£…
  - Docker å’Œ Docker Compose é…ç½®
  - Nginx é…ç½®
  - HTTPS é…ç½®
  - ç›‘æ§å’Œç»´æŠ¤
  - æ•…éšœæ’æŸ¥
  - å®‰å…¨å»ºè®®

#### 9. `QUICKSTART.md`
- **ç”¨é€”**: å¿«é€Ÿå¼€å§‹æŒ‡å—
- **å†…å®¹**:
  - ä¸‰æ­¥å¿«é€Ÿéƒ¨ç½²
  - å¸¸ç”¨å‘½ä»¤
  - åŸºæœ¬é…ç½®
  - ç®€å•æ•…éšœæ’æŸ¥

#### 10. `DOCKER_FILES.md`ï¼ˆæœ¬æ–‡ä»¶ï¼‰
- **ç”¨é€”**: Docker æ–‡ä»¶è¯´æ˜æ–‡æ¡£

### CI/CD é…ç½®

#### 11. `.github/workflows/docker-deploy.yml.example`
- **ç”¨é€”**: GitHub Actions è‡ªåŠ¨åŒ–éƒ¨ç½²é…ç½®ç¤ºä¾‹
- **åŠŸèƒ½**:
  - è‡ªåŠ¨æ„å»ºå’Œæµ‹è¯•
  - Docker é•œåƒæ„å»ºå’Œæ¨é€
  - è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨
  - å¥åº·æ£€æŸ¥
- **ä½¿ç”¨æ–¹æ³•**:
  ```bash
  # é‡å‘½åå¹¶é…ç½®
  mv .github/workflows/docker-deploy.yml.example .github/workflows/docker-deploy.yml
  # åœ¨ GitHub ä»“åº“ä¸­é…ç½® Secrets
  ```

## ğŸš€ å¿«é€Ÿä½¿ç”¨æŒ‡å—

### æ–¹å¼ä¸€: ä½¿ç”¨éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# 1. ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
chmod +x deploy.sh

# 2. æŸ¥çœ‹å¸®åŠ©
./deploy.sh --help

# 3. æ„å»ºå¹¶å¯åŠ¨
./deploy.sh --build --up

# 4. æŸ¥çœ‹æ—¥å¿—
./deploy.sh --logs

# 5. æŸ¥çœ‹çŠ¶æ€
./deploy.sh --status
```

### æ–¹å¼äºŒ: ä½¿ç”¨ Makefile

```bash
# 1. æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤
make help

# 2. æ„å»ºå¹¶å¯åŠ¨
make deploy

# 3. æŸ¥çœ‹æ—¥å¿—
make logs

# 4. æŸ¥çœ‹çŠ¶æ€
make status
```

### æ–¹å¼ä¸‰: ä½¿ç”¨ Docker Compose

```bash
# 1. æ„å»ºå¹¶å¯åŠ¨
docker compose up -d --build

# 2. æŸ¥çœ‹æ—¥å¿—
docker compose logs -f

# 3. åœæ­¢æœåŠ¡
docker compose down
```

### æ–¹å¼å››: ä½¿ç”¨åŸç”Ÿ Docker

```bash
# 1. æ„å»ºé•œåƒ
docker build -t epkeeper-chatbot:latest .

# 2. è¿è¡Œå®¹å™¨
docker run -d --name epkeeper-chatbot -p 3000:3000 epkeeper-chatbot:latest

# 3. æŸ¥çœ‹æ—¥å¿—
docker logs -f epkeeper-chatbot
```

## ğŸ“Š éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å®¢æˆ·ç«¯                         â”‚
â”‚              (æµè§ˆå™¨/ç§»åŠ¨ç«¯)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ HTTPS (443)
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Nginx åå‘ä»£ç†                      â”‚
â”‚         (SSL/TLS, Gzip, ç¼“å­˜)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ HTTP (3000)
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Docker å®¹å™¨                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   Node.js Express æœåŠ¡å™¨               â”‚     â”‚
â”‚  â”‚   (æä¾›é™æ€æ–‡ä»¶å’Œ API)                 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   å‰ç«¯é™æ€æ–‡ä»¶ (dist/public)          â”‚     â”‚
â”‚  â”‚   (HTML, CSS, JS, å›¾ç‰‡ç­‰)             â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ éƒ¨ç½²æµç¨‹

### æœ¬åœ°å¼€å‘ â†’ ç”Ÿäº§ç¯å¢ƒ

```bash
# 1. æœ¬åœ°å¼€å‘
pnpm run dev

# 2. æµ‹è¯•
pnpm run check

# 3. æ„å»º
pnpm run build

# 4. æäº¤ä»£ç 
git add .
git commit -m "feat: æ–°åŠŸèƒ½"
git push

# 5. æœåŠ¡å™¨éƒ¨ç½²
ssh user@server
cd epkeeper-chatbot
git pull
./deploy.sh --update
```

### ä½¿ç”¨ CI/CD è‡ªåŠ¨éƒ¨ç½²

```bash
# 1. é…ç½® GitHub Actions
# é‡å‘½å .github/workflows/docker-deploy.yml.example

# 2. é…ç½® GitHub Secrets
# DOCKER_USERNAME, DOCKER_PASSWORD
# SERVER_HOST, SERVER_USERNAME, SERVER_SSH_KEY

# 3. æ¨é€ä»£ç ï¼Œè‡ªåŠ¨è§¦å‘éƒ¨ç½²
git push origin main

# 4. æŸ¥çœ‹ Actions è¿è¡ŒçŠ¶æ€
# è®¿é—® GitHub ä»“åº“çš„ Actions æ ‡ç­¾é¡µ
```

## ğŸ› ï¸ å¸¸è§ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: é¦–æ¬¡éƒ¨ç½²

```bash
# ä½¿ç”¨éƒ¨ç½²è„šæœ¬
./deploy.sh --build --up

# æˆ–ä½¿ç”¨ Makefile
make deploy
```

### åœºæ™¯ 2: æ›´æ–°ä»£ç 

```bash
# ä½¿ç”¨éƒ¨ç½²è„šæœ¬
./deploy.sh --update

# æˆ–ä½¿ç”¨ Makefile
make update
```

### åœºæ™¯ 3: æŸ¥çœ‹æ—¥å¿—

```bash
# ä½¿ç”¨éƒ¨ç½²è„šæœ¬
./deploy.sh --logs

# æˆ–ä½¿ç”¨ Makefile
make logs

# æˆ–ä½¿ç”¨ Docker Compose
docker compose logs -f
```

### åœºæ™¯ 4: é‡å¯æœåŠ¡

```bash
# ä½¿ç”¨éƒ¨ç½²è„šæœ¬
./deploy.sh --restart

# æˆ–ä½¿ç”¨ Makefile
make restart

# æˆ–ä½¿ç”¨ Docker Compose
docker compose restart
```

### åœºæ™¯ 5: å®Œå…¨æ¸…ç†é‡å»º

```bash
# åœæ­¢æœåŠ¡
docker compose down

# æ¸…ç†èµ„æº
docker system prune -a -f

# é‡æ–°æ„å»ºå’Œå¯åŠ¨
docker compose up -d --build
```

### åœºæ™¯ 6: é…ç½®åŸŸåå’Œ HTTPS

```bash
# 1. é…ç½® Nginx
sudo cp nginx.conf.example /etc/nginx/sites-available/epkeeper-chatbot
sudo nano /etc/nginx/sites-available/epkeeper-chatbot  # ä¿®æ”¹åŸŸå
sudo ln -s /etc/nginx/sites-available/epkeeper-chatbot /etc/nginx/sites-enabled/

# 2. æµ‹è¯•é…ç½®
sudo nginx -t

# 3. é‡è½½ Nginx
sudo systemctl reload nginx

# 4. é…ç½® SSL
sudo certbot --nginx -d your-domain.com
```

## ğŸ“ æœ€ä½³å®è·µ

### 1. å®‰å…¨æ€§

- âœ… ä½¿ç”¨é root ç”¨æˆ·è¿è¡Œå®¹å™¨
- âœ… é…ç½® HTTPS
- âœ… è®¾ç½®é˜²ç«å¢™è§„åˆ™
- âœ… å®šæœŸæ›´æ–°ç³»ç»Ÿå’Œä¾èµ–
- âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†æ•æ„Ÿä¿¡æ¯
- âœ… é™åˆ¶å®¹å™¨èµ„æºä½¿ç”¨

### 2. æ€§èƒ½

- âœ… ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºå‡å°é•œåƒå¤§å°
- âœ… å¯ç”¨ Nginx Gzip å‹ç¼©
- âœ… é…ç½®é™æ€èµ„æºç¼“å­˜
- âœ… è®¾ç½®åˆç†çš„èµ„æºé™åˆ¶

### 3. å¯ç»´æŠ¤æ€§

- âœ… ä½¿ç”¨ Docker Compose ç®¡ç†å®¹å™¨
- âœ… é…ç½®å¥åº·æ£€æŸ¥
- âœ… å®ç°æ—¥å¿—è½®è½¬
- âœ… å®šæœŸå¤‡ä»½é‡è¦æ•°æ®
- âœ… ä½¿ç”¨ CI/CD è‡ªåŠ¨åŒ–éƒ¨ç½²

### 4. ç›‘æ§

- âœ… ç›‘æ§å®¹å™¨èµ„æºä½¿ç”¨
- âœ… é…ç½®æ—¥å¿—æ”¶é›†
- âœ… è®¾ç½®å‘Šè­¦é€šçŸ¥
- âœ… å®šæœŸæ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€

## ğŸ”§ ç¯å¢ƒå˜é‡

æ”¯æŒçš„ç¯å¢ƒå˜é‡ï¼š

| å˜é‡å | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| NODE_ENV | production | è¿è¡Œç¯å¢ƒ |
| PORT | 3000 | æœåŠ¡ç«¯å£ |

é…ç½®æ–¹æ³•ï¼š

```bash
# æ–¹æ³• 1: .env æ–‡ä»¶
echo "PORT=8080" > .env

# æ–¹æ³• 2: docker-compose.yml
environment:
  - PORT=8080

# æ–¹æ³• 3: å‘½ä»¤è¡Œ
docker run -e PORT=8080 epkeeper-chatbot
```

## ğŸ“š ç›¸å…³èµ„æº

- **Docker å®˜æ–¹æ–‡æ¡£**: https://docs.docker.com/
- **Docker Compose æ–‡æ¡£**: https://docs.docker.com/compose/
- **Nginx æ–‡æ¡£**: https://nginx.org/en/docs/
- **Let's Encrypt**: https://letsencrypt.org/

## ğŸ†˜ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: ç«¯å£è¢«å ç”¨

```bash
# æ£€æŸ¥ç«¯å£å ç”¨
sudo lsof -i :3000

# ä¿®æ”¹ç«¯å£
PORT=8080 docker compose up -d
```

### é—®é¢˜ 2: é•œåƒæ„å»ºå¤±è´¥

```bash
# æ¸…ç†ç¼“å­˜
docker builder prune -a

# é‡æ–°æ„å»º
docker compose build --no-cache
```

### é—®é¢˜ 3: å®¹å™¨æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker compose logs

# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker compose ps

# æŸ¥çœ‹å®¹å™¨è¯¦æƒ…
docker inspect epkeeper-chatbot
```

### é—®é¢˜ 4: åº”ç”¨æ— æ³•è®¿é—®

```bash
# æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œ
docker compose ps

# æ£€æŸ¥ç«¯å£æ˜ å°„
docker port epkeeper-chatbot

# æµ‹è¯•æœ¬åœ°è®¿é—®
curl http://localhost:3000

# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹æœ¬æ–‡æ¡£
2. æŸ¥çœ‹ [DEPLOYMENT.md](./DEPLOYMENT.md)
3. æŸ¥çœ‹ [QUICKSTART.md](./QUICKSTART.md)
4. æŸ¥çœ‹å®¹å™¨æ—¥å¿—
5. æäº¤ Issue

---

**æœ€åæ›´æ–°**: 2025-11-03


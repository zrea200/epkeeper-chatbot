name: Docker Build and Deploy

# 触发条件
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  # Docker 镜像名称
  IMAGE_NAME: epkeeper-chatbot
  # Docker Hub 用户名（如果使用 Docker Hub）
  # DOCKER_USERNAME: your-dockerhub-username

jobs:
  # 构建和测试
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置 Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: 安装 pnpm
      uses: pnpm/action-setup@v3
      with:
        version: 10

    - name: 安装依赖
      run: pnpm install --frozen-lockfile

    - name: 类型检查
      run: pnpm run check

    # - name: 运行测试
    #   run: pnpm run test

    - name: 构建应用
      run: pnpm run build

  # Docker 镜像构建
  docker-build:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置 Docker Buildx
      uses: docker/setup-buildx-action@v3

    # 如果使用 Docker Hub
    # - name: 登录 Docker Hub
    #   uses: docker/login-action@v3
    #   with:
    #     username: ${{ secrets.DOCKER_USERNAME }}
    #     password: ${{ secrets.DOCKER_PASSWORD }}

    # 如果使用 GitHub Container Registry
    - name: 登录 GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: 提取 Docker 元数据
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ghcr.io/${{ github.repository }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha

    - name: 构建并推送 Docker 镜像
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # 部署到服务器（可选）
  deploy:
    needs: docker-build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: 部署到服务器
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          cd /path/to/epkeeper-chatbot
          docker compose pull
          docker compose up -d
          docker image prune -f
          echo "部署完成！"

    - name: 健康检查
      run: |
        sleep 10
        curl -f ${{ secrets.APP_URL }} || exit 1
        echo "应用运行正常！"

# 配置说明:
# 
# 1. 在 GitHub 仓库中设置以下 Secrets:
#    - DOCKER_USERNAME: Docker Hub 用户名（如果使用）
#    - DOCKER_PASSWORD: Docker Hub 密码或访问令牌（如果使用）
#    - SERVER_HOST: 服务器 IP 地址
#    - SERVER_USERNAME: SSH 用户名
#    - SERVER_SSH_KEY: SSH 私钥
#    - SERVER_PORT: SSH 端口（可选，默认 22）
#    - APP_URL: 应用访问地址（用于健康检查）
#
# 2. 启用 GitHub Container Registry:
#    - 仓库 Settings -> Actions -> General -> Workflow permissions
#    - 选择 "Read and write permissions"
#
# 3. 服务器准备:
#    - 安装 Docker 和 Docker Compose
#    - 克隆项目到指定目录
#    - 配置 SSH 密钥认证

